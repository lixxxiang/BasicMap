<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 新 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.css">
    <link rel="stylesheet" href="css/daterangepicker-bs3.css">
    <link rel="stylesheet" href="css/bootstrap-toggle.min.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/bootstrap-slider.min.css">
    <link href="http://cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://hovertree.com/texiao/bootstrap/4/css/city-picker.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="css/jquery.webui-popover.min.css">
    <link title="timeline-styles" rel="stylesheet" href="css/timeline.css">
    <link rel="stylesheet" href="css/DrawHelper.css">
    <link rel="stylesheet" href="css/line/line.css">
    <link rel="stylesheet" href="css/line/blue.css">
    <link href="http://cdn.bootcss.com/bootstrap-table/1.11.0/bootstrap-table.css" rel="stylesheet">
    <link href="http://cdn.bootcss.com/bootstrap-table/1.11.0/bootstrap-table.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="css/polaris/polaris.css">

    <script type="text/javascript" src="http://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script type="text/javascript" src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://cdn.bootcss.com/Buttons/2.0.0/js/buttons.min.js"></script>
    <script type="text/javascript" src="js/moment.min.js"></script>
    <script type="text/javascript" src="http://localhost:80/Cesium/Build/Cesium/Cesium.js"></script>
    <script type="text/javascript" src="js/bootstrap-toggle.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-slider.min.js"></script>
    <script type="text/javascript" src="js/daterangepicker.js"></script>
    <script type="text/javascript"  src="http://hovertree.com/texiao/bootstrap/4/js/city-picker.data.js"></script>
    <script type="text/javascript"  src="http://hovertree.com/texiao/bootstrap/4/js/city-picker.js"></script>
    <script type="text/javascript" src="http://hovertree.com/texiao/bootstrap/4/js/main.js"></script>
    <script type="text/javascript" src="js/DrawHelper.js"></script>
    <script type="text/javascript" src="js/timeline.js"></script>
    <script type="text/javascript" src="js/watch.js"></script>
    <script type="text/javascript" src="js/icheck.js"></script>

    <script src="http://cdn.bootcss.com/bootstrap-table/1.11.0/bootstrap-table.js"></script>
    <script type="text/javascript" src="http://cdn.bootcss.com/bootstrap-table/1.11.0/bootstrap-table.min.js"></script>
    <script type="text/javascript" src="http://cdn.bootcss.com/bootstrap-table/1.11.0/locale/bootstrap-table-zh-CN.min.js"></script>

    <style>
        @import url(http://localhost:80/Cesium/Apps/Sandcastle/templates/bucket.css);
        #map:focus {
            outline: #4A74A8 solid 0.15em;
        }
        #main {
            width:100%;
            height:100%;
            border:1px #F00 solid;
        }
        label{color: black}
        #divTrans{background: rgba(255,255,255,0.7);border-color: transparent;border-radius: 10px}
        .cesium-widget-credits {
            display: none;
        }

        .cesium-viewer .cesium-widget-credits {
            display: none;
        }
        #toolbar {
            display: block;
            margin: 10px;
            padding: 0px;
            background: rgba(255,255,255,0);
        }
        #logging {
            position: absolute;
            bottom: 0px;
            right: 0;
            display: inline;
            margin: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            color: black;
            border-radius: 5px;
            width: auto;
        }
        #sliderLev .slider-selection {
            background: lightblue;}
    </style>
</head>
<body>

<div class="container-fluid">
    <!--顶部行 顶部导航栏-->
    <div id="navdiv" class="row">
        <div class="col-md-12">
            <nav class="navbar navbar-inverse" role="navigation">
                <div class="container-fluid">
                    <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="#">长光卫星</a>
                    </div>
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li class="active"><a href="#">我的地球</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">个人中心 <span class="caret"></span></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="#">每日一图</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">应用超市</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">最新数据</a></li>
                                    <li><a href="#">我的订阅</a></li>
                                    <li><a href="#">Another action</a></li>
                                    <li><a href="#">Something else here</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">我的订单</a></li>
                                </ul>
                            </li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right" id="menuRight">
                            <li><a href="#" id="btnLog" data-toggle="modal" data-target="#LoginBox">登录</a></li>
                            <li><a href="#" id="btnRegist">注册</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">个人中心 <span class="caret"></span></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="#">我的订阅</a></li>
                                    <li><a href="#">Another action</a></li>
                                    <li><a href="#">Something else here</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">我的订单</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </div><!-- /.container-fluid -->
            </nav>
        </div>

    </div>

    <!--主视图-->
    <div class="row">
        <!--地球视图-->
        <div id="cesiumContainer" class="main" style="margin-top: -17px; position: absolute; width: 100%; height: 94%"></div>
        <div id="logging"></div>
        <!--主页搜索框-->
        <div class="row" style="margin-left: 0px; position: absolute; z-index: 3">
            <div class="col-xs-6" style="margin-right: -15px">
                <input type="text" class="form-control" placeholder="填写您感兴趣的信息" style="border-bottom-right-radius: 0px; border-top-right-radius: 0px"><!--搜索框-->
            </div>
            <div class="col-xs-3" style="margin-right: -15px; margin-left: -15px">
                <button type="button" class="btn btn-default" data-toggle="collapse" style="border-bottom-left-radius: 0px; border-top-left-radius: 0px" href="#menu">
                    <span class="glyphicon glyphicon-sort-by-attributes"></span>
                </button><!--隐藏显示快捷图层框-->
            </div>
            <div class="col-xs-3" style="margin-right: -15px; margin-left: -15px">
                <button type="button" class="btn btn-default">搜索</button><!--搜索按钮-->
            </div>
        </div>
        <!--主页工具栏-->
        <div class="btn-group" style="float: right; right: 100px; top: -10px; display: inline">
            <a type="button" class="button  button-small" style="float: left; height: 33px">
                <i class="glyphicon glyphicon-pushpin"> </i>定位
            </a>
            <a type="button" class="button  button-small" style="float: left; height: 33px">
                <i class="glyphicon glyphicon-pushpin"> </i>标记
            </a>
            <a type="button" id="btnNorth" style="height: 33px" class="button  button-small">
                <i class="glyphicon glyphicon-home"> </i>HOME
            </a>
        </div>
        <!--下拉工具栏-->
        <div id="menu" class="row panel-body panel-collapse collapse" style="z-index: 2; position: absolute; margin-top: 20px; background: transparent; width: 500px; border: hidden;">
            <!--辅助导航栏-->
            <div class="col-xs-2" style="margin-left: 10px;">
                <div class="btn-group-vertical">
                    <button type="button" class="btn btn-primary" data-toggle="tab" title="我的收藏" href="#special">
                        <span class="glyphicon glyphicon-map-marker"> 我的收藏 </span>
                    </button>
                    <button type="button" class="btn btn-primary" data-toggle="tab" title="搜索" href="#hangye">
                        <span class="glyphicon glyphicon-search"> 行业应用</span>
                    </button>
                    <button type="button" class="btn btn-primary" data-toggle="tab" title="定位" href="#shenbian">
                        <span class="glyphicon glyphicon-map-marker"> 身边的遥感 </span>
                    </button>
                    <button type="button" class="btn btn-primary" data-toggle="collapse" href="#zySearch">
                        <span class="glyphicon glyphicon-copyright-mark"> 资源检索</span>
                    </button>
                    <div id="zySearch" class=" panel-collapse collapse btn-group-vertical">
                        <button type="button" class="btn btn-primary" data-toggle="tab" title="高级产品" href="#mosaic" style="border-radius: 0px; background-color: rgb(102, 153, 255)">
                            <span class="glyphicon glyphicon-th-large" > 高级产品</span>
                        </button>
                        <button type="button" class="btn btn-primary" data-toggle="tab" title="标准产品" style="border-radius: 0px; background-color: rgb(102, 153, 255)">
                            <span class="glyphicon glyphicon-th-large" > 标准产品</span>
                        </button>
                    </div>
                </div>
            </div>
            <!--导航内容-->
            <div id="myTabContent" class="col-xs-10 tab-content" style="position: absolute; margin-left: 140px; margin-top: 0px; width: 550px">
                <!--未定-->
                <div class="tab-pane fade" id="search">

                </div>
                <!--我的收藏-->
                <div class="tab-pane fade in active" id="special">
                    <div class="panel-group" id="accordion">
                        <div class="panel panel-default" style="background: rgba(255, 255, 255, 0.8); border-color: transparent; border-radius: 10px">
                            <div class="panel-heading" style="background-color: transparent; border-color: transparent">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" href="#collapseOne" style="color: black">遥感专题</a>
                                </h4>
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse in">
                                <div id="divcollection" class="panel-body" style="background-color: transparent; margin-top: -20px; border-color: transparent; width: auto">
                    <span >
                                <label class="checkbox-inline" style="font-size: 14px">
                                    <input id="checkNews" checked type="checkbox" data-toggle="toggle">每日新闻
                                </label>
                            </span><br/>
                                    <span >
                                <label class="checkbox-inline" style="font-size: 14px; margin-top: 4px">
                                    <input id="checkEvryPic" checked type="checkbox" data-toggle="toggle">每日一图
                                </label>
                            </span><br/>
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" href="#collapseTwo"> 全国</a>
                                </h4>
                            </div>
                            <div id="collapseTwo" class="form-group panel-collapse collapse">
                                <div class="docs-methods">
                                    <form class="form-inline">
                                        <div id="distpicker">
                                            <div class="form-group">
                                                <div style="position: relative;">
                                                    <input id="city-picker3" class="form-control" readonly type="text"
                                                           value="吉林省/长春市/宽城区" data-toggle="city-picker" style="width: 400px">
                                                </div>
                                            </div>
                                            <button class="btn btn-primary" id="submit" type="button">定位</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--高级产品筛选-->
                <div class="tab-pane fade" id="mosaic">
                    <div class="panel-group" id="accordion3">
                        <div class="panel panel-default" style="background: rgba(255, 255, 255, 0.5); border-color: transparent; border-radius: 10px">
                            <div class="panel-heading" style="background-color: transparent; background-color: transparent">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" href="#mosaicbody1" style="color: black">空间条件</a>
                                </h4>
                            </div>
                            <div id="mosaicbody1" class=" panel-collapse collapse in">
                                <div class="panel panel-body" style="background-color: transparent; margin-top: -5px; border-color: transparent">
                                    <div class="row " style="margin-left: 5px">
                                        <ul id="myTab2" class="nav nav-pills" style="background: rgba(255, 255, 255, 0.5); border-radius: 5px">
                                            <li class="active"><a class="active" href="#shpFile2" data-toggle="tab">导入shp</a></li>
                                            <li><a href="#LonLan2" data-toggle="tab">经纬度</a></li>
                                            <li ><a href="#currentDraw2" data-toggle="tab">绘制区域</a></li>
                                            <li><a href="#city" data-toggle="tab">行政区</a></li>
                                        </ul>
                                        <div id="mosaicTab" class="tab-content" style="background: rgba(255, 255, 255, 0); margin-left: 50px">
                                            <div class="tab-pane fade in active" id="currentDraw2" style="height: 60px">
                                                <div id="toolbar"></div>
                                            </div>
                                            <div class="tab-pane fade" id="shpFile2">
                                                <form>
                                                    <fieldset>
                                                        <label class="btn btn-default" style="margin-left: 5px; border-color: transparent; background-color: transparent">
                                                            <input id="File" type="file" onchange="showPreview(this)" style="font-size: small">
                                                            <input type="button" value="中断" id="Abort"/>
                                                        </label>
                                                        <label id="shplabel">
                                                            <input type='text' placeholder="1.请确保上传的shp文件是wgs-84坐标系；2.至少包含：.shp、.dbf、.shx和.prj四类文件，shp文件中点数不能多于200个" style="margin-left: 15px; width: 300px; height: 100px"/>
                                                        </label>
                                                        <img id="portrait" src="" width="70" height="75">
                                                        <label>读取进度：</label><progress id="Progress" value="0" max="100"></progress>
                                                        <button class="btn btn-primary">在地图加载</button>
                                                    </fieldset>
                                                </form>
                                            </div>
                                            <div class="tab-pane fade" id="LonLan2">
                                                <div class="row">
                                                    <div class="col-xs-6">
                                                        <label>最小经度：
                                                            <input type="text">
                                                        </label>
                                                    </div>
                                                    <div class="col-xs-6">
                                                        <label>最大经度：
                                                            <input type="text">
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-xs-6">
                                                        <label>最小维度：
                                                            <input type="text">
                                                        </label>
                                                    </div>
                                                    <div class="col-xs-6">
                                                        <label>最大维度：
                                                            <input type="text">
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="city">
                                                <form class="form-inline">
                                                    <div id="Div1">
                                                        <div class="form-group" style="float: left;display:inline">
                                                            <div style="position: relative;">
                                                                <input id="Text1" class="form-control" readonly type="text"
                                                                       value="吉林省/长春市/宽城区" data-toggle="city-picker" style="width: 400px">
                                                            </div>
                                                        </div>
                                                        <button class="btn btn-primary" id="Button1" type="button" style="float:left;display:inline">确定</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-defalut" style="background: rgba(255, 255, 255, 0.5)">
                                <div class="panel-heading" style="background-color: transparent; background-color: transparent">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#mosaicbody2" style="color: black">属性条件</a>
                                    </h4>
                                </div>
                                <div id="mosaicbody2" class=" panel-collapse collapse in">
                                    <div class="panel panel-body" style="background-color: transparent; margin-top: -25px; border-color: transparent">
                                        <div >
                                            <label>采集时间：</label>
                                            <input type="text" id="reservation2" value="2014-5-21 - 2014-6-21">
                                            <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
                                        </div>
                                        <div >
                                            <label >等级： <input id="sliderLev2" type="text"/></label>
                                        </div>
                                        <div id="dataTypeDiv">
                                            <label style="display: inline; float: left"> 数据类型：</label>
                                            <input type="checkbox" id="iCheckboxDT11">
                                            <label  for="iCheckboxDT11" >影 像</label>
                                            <input type="checkbox" id="iCheckboxDT12">
                                            <label for="iCheckboxDT12"> 视 频 </label>
                                        </div>
                                        <div >
                                            <label style="display: inline; float: left"> 专 题：</label>
                                            <input type="checkbox" id="iCheckboxZT1">
                                            <label for="iCheckboxZT1">每日一图</label>
                                            <input type="checkbox" id="iCheckboxZT2">
                                            <label for="iCheckboxZT2"> 农 业 </label>
                                            <input type="checkbox" id="iCheckboxZT3">
                                            <label for="iCheckboxZT3"> 水 利 </label>
                                            <input type="checkbox" id="iCheckboxZT4">
                                            <label for="iCheckboxZT4"> 林 业 </label>
                                            <input type="checkbox" id="iCheckboxZT5">
                                            <label for="iCheckboxZT5"> 环 境 </label>
                                            <input type="checkbox" id="iCheckboxZT6">
                                            <label for="iCheckboxZT6"> 监 测 </label>
                                        </div>
                                        <div>
                                            <a id="queryButton" type="button" class="button  button-small" data-toggle="collapse" href="#queryResult">查询</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-defalut" style="background: rgba(255, 255, 255, 0.5)">
                                <div class="panel-heading" style="background-color: transparent; background-color: transparent">
                                    <h4 class="panel-title">
                                        <a id="resulta" data-toggle="collapse" href="#queryResult" style="color: black">查询结果</a>
                                    </h4>
                                </div>
                                <div id="queryResult" class=" panel-collapse collapse">
                                    <div class="panel panel-body" style="background-color: transparent; margin-top: -5px; border-color: transparent">
                                        <div class="row" style="margin-left: -5px; margin-top: 5px; background-color: White; color: Black">
                                            <table id="resultTable" class="table table-hover">
                                            </table>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
        <!-- 时间轴 -->
        <div style="position: absolute; z-index: 2; width: 1000px; left: 50%; height: 30%; margin-left: -500px; bottom: 0; background-color: rgba(255, 255, 255, 0)">
            <div id='timeline' style="width: 100%; height: 100%"></div>
        </div>
        <!-- 登录模态框（Modal） -->
        <div class="modal fade" id="LoginBox" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel" style="color: black">
                            登录
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <div class="col-xs-12  ">
                                <div class="input-group">
                                    <span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span>
                                    <input type="text" id="username" name="username" class="form-control" placeholder="用户名">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-xs-12  ">
                                <div class="input-group">
                                    <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span>
                                    <input type="text" id="password" name="password" class="form-control" placeholder="密码">
                                </div>
                            </div>
                        </div>
                        <div class="form-group form-actions">
                            <div class="col-xs-4 ">
                                <button type="submit" id="btnSubmit" class="btn btn-sm btn-info"><span class="glyphicon glyphicon-off"></span> 登录</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="form-group">
                            <div class="col-xs-6 link">
                                <p class="text-center remove-margin"><small style="color: black">忘记密码？</small> <a href="javascript:void(0)"><small>找回</small></a>
                                </p>
                            </div>
                            <div class="col-xs-6 link">
                                <p class="text-center remove-margin"><small style="color: black">还没注册?</small> <a href="javascript:void(0)"><small>注册</small></a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </div>
</div>

<script type="text/javascript" src="js/Map.js"></script>
<script type="text/javascript" charset="gbk">

    function showPreview(source) {
        console.log("asdf");
        var file = source.files[0];
        if(window.FileReader) {
            var fr = new FileReader();
            console.log(fr);
            fr.onloadend = function(e) {
//                    var buf0=new Buffer(filename);
//                    console.log("asdf");
                console.log(e.target);
                console.log(typeof (e.target));
//                    document.getElementById("portrait").src = e.target.result;
            };
            fr.readAsBinaryString(file);
        }
    }
    var h = {
        init: function() {
            var me = this;

            document.getElementById('File').onchange = me.fileHandler;
            document.getElementById('Abort').onclick = me.abortHandler;

            me.status = document.getElementById('Status');
            me.progress = document.getElementById('Progress');
            me.percent = document.getElementById('Percent');

            me.loaded = 0;
            //每次读取1M
            me.step = 1024*512;
            me.times = 0;
        },
        fileHandler: function(e) {
            var me = h;

            var file = me.file = this.files[0];

            var reader = me.reader = new FileReader();

            //
            me.total = file.size;

            reader.onloadstart = me.onLoadStart;
            reader.onprogress = me.onProgress;
            reader.onabort = me.onAbort;
            reader.onerror = me.onerror;
            reader.onload = me.onLoad;
            reader.onloadend = me.onLoadEnd;
            //读取第一块
            me.readBlob(file, 0);
        },
        onLoadStart: function() {
            var me = h;
        },
        onProgress: function(e) {
            var me = h;

            me.loaded += e.loaded;
            //更新进度条
            me.progress.value = (me.loaded / me.total) * 100;
        },
        onAbort: function() {
            var me = h;
        },
        onError: function() {
            var me = h;

        },
        onLoad: function() {
            var me = h;

            if(me.loaded < me.total) {
                me.readBlob(me.loaded);
            } else {
                me.loaded = me.total;
            }
        },
        onLoadEnd: function() {
            var me = h;

        },
        readBlob: function(start) {
            var me = h;

            var blob,
                    file = me.file;

            me.times += 1;

            if(file.webkitSlice) {
                blob = file.webkitSlice(start, start + me.step + 1);
            } else if(file.mozSlice) {
                blob = file.mozSlice(start, start + me.step + 1);
            }else if(file.slice) {
                blob = file.slice(start, start + me.step + 1);
            }
            console.log(blob);
            me.reader.readAsText(blob);
        },
        abortHandler: function() {
            var me = h;

            if(me.reader) {
                me.reader.abort();
            }
        }
    };

    h.init();
    var Map = function () {
        this.elements = new Array();

        this.size = function () {
            return this.elements.length;
        }

        this.isEmpty = function () {
            return (this.elements.length < 1);
        }

        this.clear = function () {
            this.elements.length = 0;
        }

        this.put = function (_key, _value) {
            this.elements.push({
                key: _key,
                value: _value
            });
        }

        this.remove = function (_key) {
            try {
                for (var i = 0; i < this.size(); i++) {

                    if (this.elements[i].key == _key)
                        this.elements.splice(i, 1);
                    return true;
                }
            } catch (e) {
                return false;
            }
            return false;
        }

        this.get = function (_key) {

            try {
                for (var i = 0; i < this.size(); i++) {
                    if (this.elements[i].key == _key) {
                        var _value = this.elements[i].value;
                        return _value;
                    }
                }
            } catch (e) {
                return null;
            }
            return null;
        }

        this.containsKey = function (_key) {
            try {
                for (var i = 0; i < this.size(); i++) {
                    if (this.elements[i].key == _key) {
                        return true;
                    }
                }
            } catch (e) {
                return false;
            }
            return false;
        }


        this.getValues = function () {
            var values = new Array();
            try {
                for (var i = 0; i < this.size(); i++) {
                    values.push(this.elements[i].value);
                }
            } catch (e) {
                alert("Can not get Map Values ! {1}" + e.message);
                return null;
            }
            return values;
        }

        this.getKeys = function () {
            var keys = new Array();
            try {
                for (var i = 0; i < this.size(); i++) {
                    keys.push(this.elements[i].key);
                }
            } catch (e) {
                alert("Can not get Map Keys ! {1}" + e.message);
                return null;
            }
            return keys;
        }

        this.mapStr = function () {
            return this.elements.toString();

        }

    }
    //构建天地图服务
    //wgs84
    var tdtProvider1 = new Cesium.WebMapTileServiceImageryProvider({
        url: 'http://t4.tianditu.com/vec_c/wmts?',
        layer: 'vec',
        style: 'default',
        format: 'tiles',
        tileMatrixSetID: 'c',
        maximumlevel: 18,
        alpha: 1.0,
        show: true,
        tilingScheme: new Cesium.GeographicTilingScheme(),
        tileMatrixLabels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18']
    });
    //web墨卡托矢量
    var tdtProvider = new Cesium.WebMapTileServiceImageryProvider({
        url: 'http://t4.tianditu.com/vec_w/wmts?',
        layer: 'vec',
        style: 'default',
        format: 'tiles',
        tileMatrixSetID: 'w',
        maximumlevel: 3,
        alpha: 1.0,
        show: true,
    });
    //web墨卡托影像
    var tdtImageProvider = new Cesium.WebMapTileServiceImageryProvider({
        url: 'http://t2.tianditu.com/img_w/wmts?',
        layer: 'img',
        style: 'default',
        format: 'tiles',
        tileMatrixSetID: 'w',
        maximumlevel: 3,
        alpha: 1.0,
        show: true
    });
    //标注
    var ciaProvider = new Cesium.WebMapTileServiceImageryProvider({
        url: 'http://t1.tianditu.com/cva_c/wmts?',
        layer: 'cva',
        style: 'default',
        format: 'tiles',
        tileMatrixSetID: 'c',
        maximumlevel: 18,
        tilingScheme: new Cesium.GeographicTilingScheme(),
        tileMatrixLabels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18'],
        alpha: 1.0,
        show: true
    });

    //创建图层控件
    var imageryViewModels = [];
    imageryViewModels.push(new Cesium.ProviderViewModel({
        name: '天地图影像',
        iconUrl: Cesium.buildModuleUrl('Widgets/Images/ImageryProviders/bingAerial.png'),
        tooltip: '天地图web墨卡托影像图',
        creationFunction: function() {
            return tdtImageProvider;
        }
    }));
    imageryViewModels.push(new Cesium.ProviderViewModel({
        name: '天地图地图',
        iconUrl: Cesium.buildModuleUrl('Widgets/Images/ImageryProviders/tianditu.png'),
        tooltip: '天地图web墨卡托矢量图',
        creationFunction: function() {
            return tdtProvider;
        }
    }));

    var osmProvider = new Cesium.createOpenStreetMapImageryProvider({
        url: 'https://a.tile.openstreetmap.org/'
    });
    imageryViewModels.push(new Cesium.ProviderViewModel({
        name: 'OSM地图',
        iconUrl: Cesium.buildModuleUrl('Widgets/Images/ImageryProviders/openStreetMap.png'),
        tooltip: 'OpenStreetMap',
        creationFunction: function() {
            return osmProvider;
        }
    }));
    var curWwwPath = "http://localhost:15671/";
    var initialurl = curWwwPath + 'GetInitialLayers.ashx';
    var data = { xmlname: "LayersCollection" };
    var username = $.cookie("username");
    if (username != undefined && username != "null") {
        $("#btnLog").remove();
        $("#btnRegist").remove();
        var a = $("<a></a").text("退出登录");
        a.id = "btnOut";
        a.css("cursor", "pointer");
        $("#menuRight").on("click", "a", function() {
            $.cookie('username', null);
            location.reload();
        });
        var li = $("<li></li>");
        li.prepend(a);
        $("#menuRight").prepend(li);
        data = { xmlname: username };
    }
    $('#LoginBox').modal({ backdrop: 'static', keyboard: false, show: false });
    //初始化视角
    var viewer = new Cesium.Viewer('cesiumContainer', {
        //imageryProvider:Cesium.createOpenStreetMapImageryProvider({url:'http://a.tile.openstreetmap.org/',maximumlevel:19}),
        imageryProvider: tdtImageProvider,
        animation: false, //是否创建动画小器件，左下角仪表
        baseLayerPicker: true, //是否显示图层选择器
        imageryProviderViewModels: imageryViewModels,
        terrainProviderViewModels: [],
        fullscreenButton: false, //是否显示全屏按钮
        geocoder: false, //是否显示geocoder小器件，右上角查询按钮
        homeButton: false, //是否显示Home按钮
        infoBox: true, //是否显示信息框
        sceneModePicker: true, //是否显示3D/2D选择器
        selectionIndicator: false, //是否显示选取指示器组件
        timeline: false, //是否显示时间轴
        navigationHelpButton: false, //是否显示右上角的帮助按钮
        scene3DOnly: false, //如果设置为true，则所有几何图形以3D模式绘制以节约GPU资源
        navigationInstructionsInitiallyVisible: false,
        showRenderLoopErrors: false
    });
    $(".cesium-sceneModePicker-wrapper cesium-toolbar-button").on("click", this, function() {
        console.log(a);
    });
    viewer.cesiumWidget.clock.clockStep = 100;


    var camera = viewer.scene.camera;

    camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(108.9, 34.267, 20000000)
    });
    var myMap = new Map();
    var imageryLayers = viewer.imageryLayers;
    //载入xml配置文件通过使用jquery动态初始化图层及相关控件（开关 透明度 多时相按钮）
    InitialZhuantiLayers(viewer, initialurl);
    function InitialZhuantiLayers(viewer, initialurl) {
        $.getJSON(initialurl, data, function(result) {
            $.each(result.layers, function(index, layer) {
                $.each(layer, function(key, value) {
                    var currenturl = curWwwPath + value.urlSource + ".ashx?params={z}/{x}/{reverseY}/" + username;
                    var region = value.region.split(",");
                    var rectangle = Cesium.Rectangle.fromDegrees(region[0], region[1], region[2], region[3]);
                    var currentProvider = new Cesium.UrlTemplateImageryProvider({
                        url: currenturl,
                        credit: value.credit,
                        tilingScheme: new Cesium.WebMercatorTilingScheme({
                            ellipsoid: Cesium.Ellipsoid.WGS84,
                            rectangleSouthwestInMeters: new Cesium.Cartesian2(-20037508.34, -20037508.34),
                            rectangleNortheastInMeters: new Cesium.Cartesian2(20037508.34, 20037508.34)
                        }),
                        maximumLevel: value.maxlevel,
                        rectangle: rectangle
                    });
                    var spanhtml = "<span></span>";
                    var span = $(spanhtml).css({}).appendTo($("#divcollection"));
                    var labelhtml = "<label class=\"checkbox-inline\"></label>";
                    var checkid = "check" + key;
                    var inputhtml = "<input id=" + checkid + " checked type=\"checkbox\" data-toggle=\"data-toggle\">" + value.credit;
                    var check = $(inputhtml).css({ "cursor": "hand" }).appendTo(span);
                    var creditlabelhtml = "<label>" + value.credit + "</label>";
                    var credit = $(creditlabelhtml).css({ "cursor": "hand" }).appendTo(span);
                    var sliderlabelhtml = "<label class=\"in-range\"</label>";
                    var sliderlabel = $(sliderlabelhtml).css({ "font-size": "16px", "margin-left": "20px" }).appendTo(span);
                    var exid = "ex" + key;
                    var sliderinputhtml = "<input id=" + exid + " data-slider='exqSlider' type=\"text\" data-slider=\"0\" data-slider-max=\"100\" data-slider-step=\"1\" data-slider-value=\"100\"></input>";
                    $(sliderinputhtml).appendTo(sliderlabel);
                    var labeltmdhtml = "<label>透明度</label>";
                    $(labeltmdhtml).css({ "font-size": "14px", "color": "black", "margin-left": "10px", "margin-top": "4px" }).appendTo(span);
                    if (value.isMulti == "Y") {
                        var ahtml = "<a id=\"btnMultiTime1\" target=\"_blank\" href=\"" + curWwwPath + "multi.htm?" + value.region + "\" class=\"button button-glow button-border button-rounded button-primary button-tiny\" >多时相</a>";
                        $(ahtml).css({}).appendTo(span);
                    }
                    var br = "<br/>";
                    $(br).appendTo(span);

                    if (value.urlSource == "GetTile") {

                    }
                    //初始化透明度
                    $("#" + exid).slider({
                        ticks_tooltip: false
                    });
                    var layer = addAdditionalLayerOption(value.name, currentProvider, 1);
                    $("#" + exid).on("slide", function(slideEvt) {
                        layer.alpha = slideEvt.value / 100;
                    });
                    //初始化开关
                    $(check).bootstrapToggle({
                        on: '开',
                        off: '关',
                        size: 'mini'
                    });
                    $(credit).on("click", this, function() {
                        var x = (parseFloat(region[0]) + parseFloat(region[2])) / 2;
                        var y = (parseFloat(region[1]) + parseFloat(region[3])) / 2;
                        var camera = viewer.scene.camera;
                        camera.flyTo({
                            destination: Cesium.Cartesian3.fromDegrees(x, y, 363000.34038727246224)
                        });
                    });
                    $(check).change(function() {
                        if ($(this).prop('checked').toString() == 'true') {
                            layer.show = true;
                        } else {
                            layer.show = false;
                        }
                    });
                });
            });
        });
    }

    //添加额外图层
    function addAdditionalLayerOption(name, imageryProvider, alpha, show) {
        var layer = imageryLayers.addImageryProvider(imageryProvider);
        layer.alpha = Cesium.defaultValue(alpha, 1);
        layer.show = Cesium.defaultValue(show, true);
        layer.name = name;
        myMap.put(name, imageryLayers.indexOf(layer));
        return layer;
        // Cesium.knockout.track(layer, ['alpha', 'show', 'name']);
    }

    //初始化每日一图
    $("#checkEvryPic").bootstrapToggle({
        on: '开',
        off: '关',
        size: 'mini'
    });
    $("#checkEvryPic").change(function() {
        if ($(this).prop('checked').toString() == 'true') {
            $("#timeline").show();
        } else {
            $("#timeline").hide();
        }
    });
    //初始化新闻图层
    $("#checkNews").bootstrapToggle({
        on: '开',
        off: '关',
        size: 'mini'
    });
    $("#checkNews").change(function() {
        if ($(this).prop('checked').toString() == 'true') {
            viewer.dataSources.get(0).show = true;
        } else {
            viewer.dataSources.get(0).show = false;
        }
    });


    $("#sliderLev2").slider({ id: "sliderLev", min: 0, max: 17, range: true, value: [3, 16] });
    $("#resulta").click(function() {
        if ($("#queryResult").attr("aria-expanded")=="false") {
            $("#queryButton").removeAttr("data-toggle");
            $("#queryButton").removeAttr("href");
        } else {
            $("#queryButton").attr("data-toggle","collapse");
            $("#queryButton").attr("href","#queryResult");
        }
    });

    var startdate;
    var enddate;
    $('#reservation2').daterangepicker(null, function(start, end, label) {
        startdate = start.toISOString();
        enddate = end.toISOString();
    });
    String.prototype.NoSpace = function()
    {
        return this.replace(/\s+/g, "");
    }
    //点击查询按钮进行查询
    $("#queryButton").click(function() {
        if(window.FileReader) {
            var fr = new FileReader();
            // add your code here
            alert("supported by your browser!");
        }
        else {
            alert("Not supported by your browser!");
        }
        if ($("#queryResult").attr("aria-expanded")=="true") {
            $("#queryButton").removeAttr("data-toggle");
            $("#queryButton").removeAttr("href");
        }
        //空间条件

        //属性条件
        var datesarray = [];
        datesarray.push(startdate);
        datesarray.push(enddate);
        var dataTypearray = [];
        $($("input[id^='iCheckboxDT']")).each(function() {
            if($(this).parent().attr("class") == "icheckbox_polaris checked") {
                dataTypearray.push($(this).parent().next().html().NoSpace());
            }
        });
        var dataZhuantiarray = [];
        $($("input[id^='iCheckboxZT']")).each(function() {
            if($(this).parent().attr("class") == "icheckbox_polaris checked") {
                dataZhuantiarray.push($(this).parent().next().html().NoSpace());
            }
        });
        var level = $("#sliderLev2").attr("data-value");
        var data = {
            "dates":datesarray.toString(),
            "datatype":dataTypearray.toString(),
            "datazt":dataZhuantiarray.toString(),
            "level":level.toString()
        };
        console.log(data);
        console.log(JSON.stringify(data));
        $.ajax({
            type: "post",
            url:curWwwPath+"GetMosaicQueryResult.ashx",
            dataType: "json",
            data:data,
            success:function(result) {
                console.log(result);
            }
        });
    });
    //    初始化新闻数据
    InitialNews(viewer);
    function InitialNews(viewer) {
        viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);
        viewer.infoBox.viewModel.enableCamera = false;
        var options = {
            markerColor: Cesium.Color.ORANGE,
            markerSize: 38
        };
        var dataSourcePromise = Cesium.GeoJsonDataSource.load(curWwwPath + 'geojson/testGeojson.geojson');
        dataSourcePromise.then(function(dataSource) {
            viewer.dataSources.add(dataSource);
            var entities = dataSource.entities.values;
            entities.forEach(function(entity) {
                entity.billboard.image = curWwwPath + 'images/48.ico';
            });
            var pixelRange = 150;
            var minimumClusterSize = 2;
            var enabled = true;
            dataSource.clustering.enabled = enabled;
            dataSource.clustering.pixelRange = pixelRange;
            dataSource.clustering.minimumClusterSize = minimumClusterSize;
            var removeListener;
            var pinBuilder = new Cesium.PinBuilder();
            var pin50 = pinBuilder.fromText('50+', Cesium.Color.RED, 48).toDataURL();
            var pin40 = pinBuilder.fromText('40+', Cesium.Color.ORANGE, 48).toDataURL();
            var pin30 = pinBuilder.fromText('30+', Cesium.Color.CHARTREUSE, 48).toDataURL();
            var pin20 = pinBuilder.fromText('20+', Cesium.Color.GREEN, 48).toDataURL();
            var pin10 = pinBuilder.fromText('10+', Cesium.Color.AQUA, 48).toDataURL();
            var singleDigitPins = new Array(8);
            for (var i = 0; i < singleDigitPins.length; ++i) {
                singleDigitPins[i] = pinBuilder.fromText('' + (i + 2), Cesium.Color.VIOLET, 48).toDataURL();
            }
            var clustermap = new Map();
            customStyle();
            function customStyle() {
                if (Cesium.defined(removeListener)) {
                    removeListener();
                    removeListener = undefined;
                } else {
                    removeListener = dataSource.clustering.clusterEvent.addEventListener(function(clusteredEntities, cluster) {
//                        var cid = cluster.billboard._index;
//                        if (cid == 0) {
//                            clustermap.clear();
//                        }
//                        clustermap.put(cid, clusteredEntities);
                        cluster.label.show = false;
                        cluster.billboard.show = true;
                        cluster.billboard.verticalOrigin = Cesium.VerticalOrigin.BOTTOM;
                        if (clusteredEntities.length >= 50) {
                            cluster.billboard.image = pin50;
                            //                        cluster.billboard.image = 'http://localhost:15671/images/48.ico';
                            //                        cluster.billboard.image.width = 3;
                            //                        cluster.billboard.image.height = 3;
                        } else if (clusteredEntities.length >= 40) {
                            cluster.billboard.image = pin40;
                            //                        cluster.billboard.image = 'http://localhost:15671/images/48.ico';
                            //                        cluster.billboard.image.width = 3;
                            //                        cluster.billboard.image.height = 3;
                        } else if (clusteredEntities.length >= 30) {
                            cluster.billboard.image = pin30;
                            //                        cluster.billboard.image = 'http://localhost:15671/images/48.ico';
                            //                        cluster.billboard.image.width = 3;
                            //                        cluster.billboard.image.height = 3;
                        } else if (clusteredEntities.length >= 20) {
                            cluster.billboard.image = pin20;
                            //                        cluster.billboard.image = 'http://localhost:15671/images/48.ico';
                            //                        cluster.billboard.image.width = 3;
                            //                        cluster.billboard.image.height = 3;
                        } else if (clusteredEntities.length >= 10) {
                            cluster.billboard.image = pin10;
                            //                        cluster.billboard.image = 'http://localhost:15671/images/48.ico';
                            //                        cluster.billboard.image.width = 3;
                            //                        cluster.billboard.image.height = 3;
                        } else {
                            cluster.billboard.image = singleDigitPins[clusteredEntities.length - 2];
                            //                        cluster.billboard.image = 'http://localhost:15671/images/48.ico';
                        }

                    });
                }

                // force a re-cluster with the new styling
//                var pixelRange = dataSource.clustering.pixelRange;
//                dataSource.clustering.pixelRange = 0;
//                dataSource.clustering.pixelRange = pixelRange;
            }


            var _isPop = false;
            var _isDown = false;
            var pickedLabel;
            var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
            handler.setInputAction(function(movement) {
                var currentpickedLabel = viewer.scene.pick(movement.position);

                if (!Cesium.defined(currentpickedLabel)) {
                    return;
                }
                if (typeof (currentpickedLabel.id) == "undefined") {
                    var pickentities = clustermap.get(currentpickedLabel.primitive._index);
                    return;
                }
                var windowposition = Cesium.SceneTransforms.wgs84ToWindowCoordinates(viewer.scene, currentpickedLabel.primitive.position);
                var left = windowposition.x + 20;
                var top = windowposition.y - 20;
                pickedLabel = currentpickedLabel;
                var title =pickedLabel.id._properties.title;
//                var newsId = pickedLabel.id._description._value;
//                var newsurl = curWwwPath + "new.htm?" + pickedLabel.id._properties.url;
                var newsurl = pickedLabel.id._properties.url;
                console.log(pickedLabel.id._properties.url);
                if (!document.getElementById('pop')) {
                    var newsdivhtml = "<div id=\"pop\"><div/>";
                    var newsdiv = $(newsdivhtml).css({ "height": "650px", "width": "500px", "background-color": "white", "left": left + "px", "top": top + "px", "z-index": 200, "position": "absolute" });
                    newsdiv.appendTo($("#cesiumContainer"));
                    var titledivhtml = "<h3 id=\"newstitle\">" + title + "</h3>";
                    var titlediv = $(titledivhtml).css({ "color": "black", "font-size": 13, "display": "inline" }).appendTo($(newsdiv));
                    var a = "<a>x</a>";
                    $(a).css({ "float": "right", "margin-right": "5px" }).appendTo(newsdiv);
                    $("#pop").on('click', "a", function() {
                        console.log("asdf");
                        newsdiv.remove();
                    });

                    var newsiframehtml = "<iframe id=\"newsframe\" src='" + newsurl+ "'></iframe>";
                    var newsiframe = $(newsiframehtml).css({ "height": "630px", "width": "500px" }).appendTo($(newsdiv));
                } else {
                    $('#newstitle').html(title);
                    $('#newsframe').attr("src", newsurl);
                    $('#pop').css({ "left": left + "px", "top": top + "px" });
                }
                _isPop = true;
                _isDown = true;
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            //新闻跟随移动
            handler.setInputAction(function(move) {
                if (_isDown && _isPop) {
                    var windowPosition = Cesium.SceneTransforms.wgs84ToWindowCoordinates(viewer.scene, pickedLabel.primitive.position);

                    var top = windowPosition.y - 20;
                    var left = windowPosition.x + 20;
                    $('#pop').css({ "left": left + "px", "top": top + "px" });
                }
            }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

            handler.setInputAction(function(move) {
                if (_isDown && _isPop) {
                    var windowPosition = Cesium.SceneTransforms.wgs84ToWindowCoordinates(viewer.scene, pickedLabel.primitive.position);

                    var top = windowPosition.y - 20;
                    var left = windowPosition.x + 20;
                    $('#pop').css({ "left": left + "px", "top": top + "px" });
                }
            }, Cesium.ScreenSpaceEventType.WHEEL);
        });
    }

    $($("input[id^='iCheckbox']")).each(function() {
        $(this).iCheck({
            checkboxClass: 'icheckbox_polaris'
        });
    });

    $('#resultTable').bootstrapTable({
        url: 'data1.json',
        pagination: true, //分页
        singleSelect: false,
        locale:"zh-US" , //表格汉化
        search: true, //显示搜索框,
        sidePagination:"client",
        pageNumber:1,
        pageSize:10,
        pageList:[5,10,15,50,100],
        showColumns:true,
        showPaginationSwitch:true,
        showRefresh:true,
        showToggle:true,
        smartDisplay:true,
        detailView:true,
        detailFormatter:function(index,row,element) {
            return "详细信息"+index + row;
        },
        columns: [{
            field: 'id',
            title: '编号'
        }, {
            field: 'name',
            title: '名称'
        }, {
            field: 'price',
            title: '价格'
        },
            {
                field: 'price',
                title: '时间'
            },
            {
                field: 'price',
                title: '数据类型'
            },
            {
                field: 'price',
                title: '数据等级'
            },
            {
                field: 'price',
                title: '缩略图'
            },
            {
                title: '操作',
                field: 'id',
                align: 'center',
                formatter:function(value,row,index){
                    var e = '<a href="#" mce_href="#" onclick="edit(\''+ row.id + '\')">下载</a> ';
                    var d = '<a href="#" mce_href="#" onclick="del(\''+ row.id +'\')">多时相</a> ';
                    return e+d;
                }
            }]
    });
    $(document).ready(function() {


        $('#reservation3').daterangepicker(null, function(start, end, label) {

        });
        $("#reservation3").on('apply.daterangepicker', function() {

        });

        //登录
        $("#btnSubmit").click(function() {
            var data = {
                username: $('#username').val(),
                password: $('#password').val()
            };
            $.ajax({
                type: "post",
                url: curWwwPath + "Login.ashx",
                data: data,
                dataType: 'text',
                success: function(result) {
                    console.log(result);
                    if (result != "用户名或密码错误") {
                        $.cookie("username", result);
                        $('#LoginBox').modal('hide');
                        location.reload();
                    }
                },
                error: function() { console.log('error') }
            });
        });
        //地图HOME键
        $("#btnNorth").click(function() {
            var camera = viewer.scene.camera;
            var position = camera.position;
            console.log(camerapo);
            camera.flyTo({
//                destination: Cesium.Cartesian3.fromDegrees(108.9, 34.267, 10000000.34038727246224)
                destination:camerapo
            });
        });
    });

    //初始化每日一图
    $.getJSON(curWwwPath + "GetEveryPicList.ashx", {}, function(result) {
        var options = {
            hash_bookmark: false,
            scale_factor: 0.25,
            timenav_height_percentage: 50,
            slide_default_fade: "10%",
            zoom_sequence: [, 0.01, 0.25, 0.5, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610],
            timenav_height_min: 0
        }
        var timeline = new TL.Timeline('timeline', result, options);
        $(".tl-timemarker").on('click', this, function() {
            $(".tl-slider-background").css({ "background": "rgba(255,255,255,0.78)" });
            var key = $(".tl-timemarker").index($(this)).toString();
            var event = result.events[key];
            var region = event.region.split(",");
            var x = (parseFloat(region[0]) + parseFloat(region[2])) / 2;
            var y = (parseFloat(region[1]) + parseFloat(region[3])) / 2;
            camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(x,y,20000)
            });
            if (!myMap.containsKey(key)) {
                var provider = new Cesium.UrlTemplateImageryProvider({
                    url: curWwwPath+"GetEveryPicTile.ashx?params={z}/{x}/{y}/"+key,
                    credit: key,
                    tilingScheme: new Cesium.WebMercatorTilingScheme({
                        ellipsoid: Cesium.Ellipsoid.WGS84,
                        rectangleSouthwestInMeters: new Cesium.Cartesian2(-20037508.34, -20037508.34),
                        rectangleNortheastInMeters: new Cesium.Cartesian2(20037508.34, 20037508.34)
                    }),
                    maximumLevel: 18,
                    rectangle: Cesium.Rectangle.fromDegrees(region[0],region[1],region[2],region[3])
                });
                addAdditionalLayerOption(key, provider, 1);
            }
        });
        $(".tl-slidenav-next").on("click", this, function() {
            $(".tl-slider-background").css({ "background": "rgba(255,255,255,0.78)" });
        });
        $(".tl-slidenav-previous").on("click", this, function() {
            $(".tl-slider-background").css({ "background": "rgba(255,255,255,0.78)" });
        });
        $(".tl-attribution").children("a").html(" ");
        $(".tl-attribution").children("a").attr("href", "");
        $(".tl-slider-background").css({ "background": "rgba(255,255,255,0.78)" });
        $("#timeline").css({ "background": "rgba(255,1,1,0" });
        $(".tl-slide-content").attr("width", "auto").css({ "padding-left": "0px", "padding-right": "0px" });
        $(".tl-media").css({ "max-width": "1000px", "margin-top": "17px" });
        $(".tl-text").css({ "width": "500px", "background": "rgba(255,255,255,0)" });
        $(".tl-text-content-container").children(".tl-headline").css({ "width": "500px", "font-size": "20px" });
        var margin = $(".tl-slide-scrollable-container").width();
        margin = 0 - margin / 2;
        $(".tl-slide-scrollable-container").css({ "left": "50%", "margin-left": margin + "px", "position": "absolute" });
    });
    var scene = viewer.scene;
    var drawer = new DrawHelper(viewer);
    var toolbar = drawer.addToolbar(document.getElementById("toolbar"), {
        buttons: ['marker', 'polyline', 'polygon', 'circle', 'extent']
    });
    toolbar.addListener('polylineCreated', function(event) {
        loggingMessage('绘制了一个 ' + event.positions.length + ' 个节点的多边形');
        var polyline = new DrawHelper.PolylinePrimitive({
            positions: event.positions,
            width: 5,
            geodesic: true
        });
        scene.primitives.add(polyline);
        polyline.setEditable();
        polyline.addListener('onEdited', function(event) {
            loggingMessage('绘制了一个 ' + event.positions.length + ' 个节点的多边形');
        });

    });
    toolbar.addListener('polygonCreated', function(event) {
        loggingMessage('绘制了一个 ' + event.positions.length + ' 个节点的多边形');
        var polygon = new DrawHelper.PolygonPrimitive({
            positions: event.positions,
            material : Cesium.Material.fromType('Checkerboard')
        });
        scene.primitives.add(polygon);
        polygon.setEditable();
        polygon.addListener('onEdited', function(event) {
            loggingMessage('绘制了一个 ' + event.positions.length + ' 个节点的多边形');
        });

    });
    toolbar.addListener('circleCreated', function(event) {
        loggingMessage('绘制了一个圆: 圆心是 ' + event.center.toString() + ' 半径是 ' + event.radius.toFixed(1) + ' 米');
        var circle = new DrawHelper.CirclePrimitive({
            center: event.center,
            radius: event.radius,
            material: Cesium.Material.fromType(Cesium.Material.RimLightingType)
        });
        scene.primitives.add(circle);
        circle.setEditable();
        circle.addListener('onEdited', function(event) {
            loggingMessage('绘制了一个圆: 圆心是 ' + event.radius.toFixed(1) + ' 米');
        });
    });
    toolbar.addListener('extentCreated', function(event) {

        var extent = event.extent;
        loggingMessage('绘制了一个矩形(N: ' + extent.north.toFixed(3) + ', E: ' + extent.east.toFixed(3) + ', S: ' + extent.south.toFixed(3) + ', W: ' + extent.west.toFixed(3) + ')');
        var extentPrimitive = new DrawHelper.ExtentPrimitive({
            extent: extent,
            material: Cesium.Material.fromType(Cesium.Material.StripeType)
        });
        scene.primitives.add(extentPrimitive);
        extentPrimitive.setEditable();
        extentPrimitive.addListener('onEdited', function(event) {
            loggingMessage('编辑了一个矩形: extent is (N: ' + event.extent.north.toFixed(3) + ', E: ' + event.extent.east.toFixed(3) + ', S: ' + event.extent.south.toFixed(3) + ', W: ' + event.extent.west.toFixed(3) + ')');
        });
    });
    var logging = document.getElementById('logging');
    function loggingMessage(message) {
        logging.innerHTML = message;
    }
    $(".toolbar").css({"background":"rgba(255,255,255,0.3)","display":"block"});
    $(".toolbar").children(":first").remove();
    var camerapo=new Cesium.Cartesian3();
    var mouseHandler=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    mouseHandler.setInputAction(function(wheel) {

        camerapo.x = viewer.scene.camera.position.x;
        camerapo.y = viewer.scene.camera.position.y;
        camerapo.z = viewer.scene.camera.position.z;
        console.log(camerapo);
    },Cesium.ScreenSpaceEventType.MIDDLE_DOWN );
</script>

</body>
</html>